# 分支预测实验

## 分支预测器的实现

BHT记录每个PC最近几次跳转的状态，捕捉跳转规律。

PHT使用2-bit状态，维护是否跳转。

根据PC的值，查找BHT表的跳转状态v，把v作为PHT的索引，查找是否跳转。

按照同样的方法更新。

## datapath更新

1. 原来ID阶段判断BEQ指令跳转部分删除，并**移除branchstall**

2. 将PC选择是否跳转的判断条件改为pred_takeD，即由分支预测器决定是否跳转

3. 将PC从IF阶段一直传到WB阶段，用于更新预测器

4. 将BEQ指令跳转的目标地址PCBranchD和PC+8传递到MEM阶段，用于预测失败后更新流水线

   **预测失败分析**：

   MIPS体系结构规定，Branch类指令后面有一条转移延迟槽指令，该指令无论是否跳转都要执行。因此，在预测失败后，若不跳转，则应当返回PC+8处继续执行，若跳转，则应当跳转PC+4+offset处继续执行。

   同时，在MEM阶段发现跳转失败，应当刷新IF和ID阶段流水线，用正确的地址替换nextpc。EXE阶段对应转移延迟槽指令，无需刷新。

   **备选方案**：可以在EXE阶段发起刷新流水线请求，此时只需要刷新IF阶段

5. 在EXE阶段判断实际是否需要跳转。

   BEQ指令在ID阶段进行预测，前面一共有3条指令，EXE MEM WB阶段各一条。
   
   判断条件为：eq1==eq2。因此，需要考虑写后读相关问题。
   
   其中原来的WB阶段指令可以通过前推到ID阶段或者下降沿写入寄存器堆传递。无需额外考虑。
   
   原来的MEM阶段指令，简称MEM_p，**在branch指令到达MEM阶段时**，已经退出流水线。如果MEM_p更新了eq1或者eq2，那么最新的值无法被取到**（branch指令只能访问寄存器堆一次，这个时候它已经到了MEM阶段）**。所以，要在MEM_p退出流水线之前，完成是否跳转的仲裁。即在EXE阶段判断，使用数据前推解决写后读相关问题。
   
   
   
   

